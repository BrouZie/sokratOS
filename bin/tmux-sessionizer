#!/bin/bash
# ========================================
# TMUX SESSIONIZER - ThePrimeagen inspired
# ========================================

# Regular directories to search
SEARCH_PATHS=(
    "$HOME/Robotics"
    "$HOME/Projects"
    "$HOME/School"
    "$HOME/Documents"
)

# Specific .config subdirectories to include
CONFIG_DIRS=(
    "nvim"
		"hypr"
		"rofi"
		"kitty"
    "waybar"
    "bash"
		"matugen"
		"sokratOS"
		"fastfetch"
    "gtk-3.0"
    "gtk-4.0"
    "zathura"
    "swaync"
    "ghostty"
)

# Specifig .local subdirectories to include
LOCAL_DIRS=(
    "bin"
)

# Specific .local/share subdirectories to include
LOCAL_SHARE_DIRS=(
    "applications"
    "sokratOS"
)

MAX_DEPTH=3

# =====================================
# FUNCTIONS
# =====================================

get_directories() {
    local dirs=()
    
    # Get regular search paths
    for path in "${SEARCH_PATHS[@]}"; do
        if [[ -d "$path" ]]; then
            while IFS= read -r dir; do
                dirs+=("$dir")
            done < <(find "$path" -mindepth 1 -maxdepth "$MAX_DEPTH" -type d \
                \( -name '.git' -o -name 'node_modules' -o -name '.venv' -o -name '__pycache__' -o -name '.cache' \) -prune -o \
                -type d -print 2>/dev/null)
        fi
    done
    
    # Get specific .config directories
    for config_dir in "${CONFIG_DIRS[@]}"; do
        local full_path="$HOME/.config/$config_dir"
        if [[ -d "$full_path" ]]; then
            dirs+=("$full_path")
        fi
    done

    # Get specific .local/share directories
    for share_dir in "${LOCAL_DIRS[@]}"; do
        local full_path="$HOME/.local/$share_dir"
        if [[ -d "$full_path" ]]; then
            dirs+=("$full_path")
        fi
    done
    
    # Get specific .local/share directories
    for share_dir in "${LOCAL_SHARE_DIRS[@]}"; do
        local full_path="$HOME/.local/share/$share_dir"
        if [[ -d "$full_path" ]]; then
            dirs+=("$full_path")
        fi
    done
    
    # Print unique, sorted directories
    printf '%s\n' "${dirs[@]}" | sort -u
}

sessionize() {
    local selected="$1"
    
    # Exit if nothing selected
    [[ -z "$selected" ]] && exit 0
    
    # Resolve symlinks to get the actual path
    selected=$(readlink -f "$selected")
    
    # Create session name from directory basename
    # Handle dots and dashes in directory names
    local selected_name=$(basename "$selected" | tr '.' '_' | tr '-' '_')
    
    # Check if we're inside tmux
    if [[ -z "$TMUX" ]]; then
        # Not in tmux - create new session or attach
        if ! tmux has-session -t "$selected_name" 2>/dev/null; then
            tmux new-session -s "$selected_name" -c "$selected"
        else
            tmux attach-session -t "$selected_name"
        fi
    else
        # Inside tmux - create session if doesn't exist
        if ! tmux has-session -t "$selected_name" 2>/dev/null; then
            tmux new-session -ds "$selected_name" -c "$selected"
        fi
        # Switch to the session
        tmux switch-client -t "$selected_name"
    fi
}

# =====================================
# MAIN
# =====================================

# If directory is provided as argument, use it directly
if [[ $# -eq 1 ]]; then
    sessionize "$1"
else
    # Use fzf to select from all found directories
    selected=$(get_directories | fzf \
        --preview 'ls -lah --color=always {} 2>/dev/null | head -50' \
        --preview-window=right:50%:wrap \
        --bind 'ctrl-/:toggle-preview' \
        --header 'Select directory (Ctrl-/ toggle preview)' \
        --height=100% \
				--layout=reverse)
    
    sessionize "$selected"
fi

#!/usr/bin/env bash

# Check if the user provided an argument
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <path_to_image>"
    exit 1
fi

WALL="$1"
CACHE_DIR="$HOME/.cache/sokratOS/theme"
PROCESSED_IMG="$CACHE_DIR/theme-source.png"

mkdir -p "$CACHE_DIR"

magick "$WALL" \
  -resize 1920x1080^ \
  -gravity center -crop 70%x70%+0+0 +repage \
  -resize 1920x1080 \
  "$PROCESSED_IMG"

# Set wallpaper
swww img "$WALL" -t fade

# Generate matugen colors
matugen image "$PROCESSED_IMG"

refresh-app-daemons

# Image analysis variables
PRIMARY_HEX=$(<~/.config/sokratOS/matugen/.primary-hex.txt)
COLOR1=$(pastel format name $PRIMARY_HEX)
SHADE=$(magick "$WALL" \
  -alpha remove -alpha off -colorspace Gray \
  -format "%[fx:mean]" info: | awk '{print ($1<0.35)?"dark":"light"}'
)

THEMES_DIR="$HOME/.local/share/sokratOS/themes"
CURRENT_THEME_DIR="$HOME/.config/sokratOS/current/theme/colors.conf"
# CURRENT_THEME_DIR1="$HOME/.config/sokratOS/current/theme/ghostty-colors"

set_theme() {
	local theme="$1"
	notify-send "$SHADE $COLOR1: $theme"
	ln -nsf "$THEMES_DIR/$theme/colors.conf" "$CURRENT_THEME_DIR"
	# ln -nsf "$THEMES_DIR/$theme/ghostty-colors" "$CURRENT_THEME_DIR1"
}

# Change kitty pallete based on image analysis
case "$SHADE $COLOR1" in
  "dark lightsteelblue")  set_theme nord ;;
  "light lightsteelblue") set_theme tokyonight ;;
	"dark sandybrown") set_theme tokyonight ;;
	"dark mediumaquamarine") set_theme osaka-jade ;;

  # Shade-agnostic: any SHADE + color
  *" lightsalmon")        set_theme gruvbox ;;
  *" lightskyblue")       set_theme everforest ;;
  *" skyblue")            set_theme nord ;;
  *" plum")               set_theme catppuccin ;;
  *" powderblue")         set_theme everforest ;;
  *" darkkhaki")          set_theme rosepine ;;

  # Different theme per shade for same color
  "light lightpink")      set_theme rosepine ;;
  "dark lightpink")       set_theme nightfox ;;

  # Example: two different choices based on shade
  "light darkseagreen")   set_theme everforest ;;
  "dark darkseagreen")    set_theme gruvbox ;;

  # Fallback
  *) notify-send "$SHADE $COLOR1" && sokratos-themes &&  exit 0 ;;
esac

# Refresh kitty
pkill -SIGUSR1 kitty

#!/bin/bash
# ========================================
# TMUX SESSIONIZER - CD Version
# ========================================

# Regular directories to search
SEARCH_PATHS=(
    "$HOME/Robotics"
    "$HOME/Projects"
    "$HOME/School"
    "$HOME/Documents"
)

# Specific .config subdirectories to include
CONFIG_DIRS=(
    "nvim"
    "hypr"
    "rofi"
    "kitty"
    "waybar"
    "bash"
    "matugen"
    "sokratOS"
    "fastfetch"
    "gtk-3.0"
    "gtk-4.0"
    "zathura"
    "swaync"
    "ghostty"
)

# Specific .local subdirectories to include
LOCAL_DIRS=(
    "bin"
)

# Specific .local/share subdirectories to include
LOCAL_SHARE_DIRS=(
    "applications"
    "sokratOS"
)

MAX_DEPTH=3

# =====================================
# FUNCTIONS
# =====================================

get_directories() {
    local dirs=()

    # Get regular search paths
    for path in "${SEARCH_PATHS[@]}"; do
        if [[ -d "$path" ]]; then
            while IFS= read -r dir; do
                dirs+=("$dir")
            done < <(find "$path" -mindepth 1 -maxdepth "$MAX_DEPTH" \
                \( -name '.git' -o -name 'node_modules' -o -name '.venv' -o -name '__pycache__' -o -name '.cache' \) -prune -o \
                -type d -print 2>/dev/null)
        fi
    done

    # Get specific .config directories
    for config_dir in "${CONFIG_DIRS[@]}"; do
        local full_path="$HOME/.config/$config_dir"
        if [[ -d "$full_path" ]]; then
            dirs+=("$full_path")
        fi
    done

    # Get specific .local directories
    for local_dir in "${LOCAL_DIRS[@]}"; do
        local full_path="$HOME/.local/$local_dir"
        if [[ -d "$full_path" ]]; then
            dirs+=("$full_path")
        fi
    done

    # Get specific .local/share directories
    for share_dir in "${LOCAL_SHARE_DIRS[@]}"; do
        local full_path="$HOME/.local/share/$share_dir"
        if [[ -d "$full_path" ]]; then
            dirs+=("$full_path")
        fi
    done

    # Print unique, sorted directories
    printf '%s\n' "${dirs[@]}" | sort -u
}

find_directory_in_tmux() {
    local target_dir="$1"
    local matches=()

    # Get all tmux sessions, windows, and panes with their working directories
    # Format: session_name|window_index|pane_index|directory
    while IFS='|' read -r session_name window_index pane_index pane_dir; do
        # Resolve symlinks for comparison
        pane_dir=$(readlink -f "$pane_dir" 2>/dev/null || echo "$pane_dir")

        if [[ "$pane_dir" == "$target_dir" ]]; then
            matches+=("$session_name|$window_index|$pane_index")
        fi
    done < <(tmux list-panes -a -F "#{session_name}|#{window_index}|#{pane_index}|#{pane_current_path}" 2>/dev/null)

    # Return first match (or empty if no matches)
    if [[ ${#matches[@]} -gt 0 ]]; then
        echo "${matches[0]}"
        return 0
    fi
    return 1
}

tmux_sessions_running() {
    tmux list-sessions &>/dev/null
}

tmux_visible_in_hypr() {
    local title_regex="${TMUX_TITLE_REGEX:-^tmux}"

    local active_workspaces
    active_workspaces=$(hyprctl monitors -j 2>/dev/null \
        | jq '[.[].activeWorkspace.id]' 2>/dev/null) || return 1

    hyprctl clients -j 2>/dev/null \
        | jq --argjson ws "$active_workspaces" --arg re "$title_regex" -e '
            .[]
            | select(.workspace.id as $id | $ws | index($id) != null)
            | select(.title | test($re))
        ' >/dev/null 2>&1
}

tmux_window_exists_in_hypr() {
    hyprctl clients -j 2>/dev/null \
        | jq -e '
            .[]
            | select(
                # current window title contains "tmux" or "__sokratOS_nav__"
                (.title // ""        | test("tmux"))
                or (.title // ""     | test("__sokratOS_nav__"))
                # OR initialTitle contains them (in case title changed later)
                or (.initialTitle // "" | test("tmux"))
                or (.initialTitle // "" | test("__sokratOS_nav__"))
            )
        ' >/dev/null 2>&1
}

navigate_to_directory() {
    local selected="$1"

    # Exit if nothing selected (e.g. fzf cancelled)
    [[ -z "$selected" ]] && exit 0

    # Resolve symlinks and ensure the path exists
    if ! selected=$(readlink -f -- "$selected" 2>/dev/null); then
        printf 'Error: path does not exist: %s\n' "$1" >&2
        exit 1
    fi

    if [[ ! -d "$selected" ]]; then
        printf 'Error: not a directory: %s\n' "$selected" >&2
        exit 1
    fi

    # =====================================
    # CASE 1: Inside tmux already
    # =====================================
    if [[ -n "$TMUX" ]]; then
        local found_location
        found_location=$(find_directory_in_tmux "$selected") || true

        if [[ -n "$found_location" ]]; then
            # Parse session|window|pane using | as delimiter
            IFS='|' read -r session_name window_index pane_index <<< "$found_location"

            local current_session
            current_session=$(tmux display-message -p '#S')

            if [[ "$current_session" == "$session_name" ]]; then
                # Same session - just switch to window and pane
                tmux select-window -t ":$window_index"
                tmux select-pane   -t ".$pane_index"
            else
                # Different session - switch the client directly
                tmux switch-client -t "$session_name:$window_index.$pane_index"
            fi
        else
            # Directory not open anywhere yet: create new window and kill spawning pane
            local spawning_pane="$TMUX_PANE"
            tmux new-window -c "$selected"
            tmux kill-pane  -t "$spawning_pane"
        fi

        return
    fi

    # =====================================
    # CASE 2: Outside tmux (no $TMUX)
    # =====================================

    # If no tmux server is running at all, OR a tmux window exists in Hyprland,
    # behave like fzf alt-c: just print the directory and exit. A wrapper
    # function in your shell will then `cd` into it.
    if ! tmux_sessions_running || tmux_window_exists_in_hypr; then
        printf '%s\n' "$selected"
        return 0
    fi

    # Tmux server exists but *no* tmux window in Hyprland:
    # safe to integrate with tmux (attach / reuse windows).
    local found_location
    found_location=$(find_directory_in_tmux "$selected") || true

    if [[ -n "$found_location" ]]; then
        IFS='|' read -r session_name window_index pane_index <<< "$found_location"
        tmux attach-session -t "$session_name:$window_index.$pane_index"
    else
        local existing_session
        existing_session=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | head -n1)
        tmux attach-session -t "$existing_session" \; new-window -c "$selected"
    fi
}

# =====================================
# MAIN
# =====================================

# If directory is provided as argument, use it directly
if [[ $# -eq 1 ]]; then
    navigate_to_directory "$1"
else
    # Use fzf to select from all found directories
    selected=$(get_directories | fzf \
        --preview 'ls -lah --color=always {} 2>/dev/null | head -50' \
        --preview-window=right:50%:wrap \
        --bind 'ctrl-/:toggle-preview' \
        --header 'Select directory (Ctrl-/ toggle preview)' \
        --height=100% \
        --layout=reverse)

    navigate_to_directory "$selected"
fi
